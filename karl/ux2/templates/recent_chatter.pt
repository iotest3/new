<metal:block use-macro="main_template">

   <metal:content fill-slot="content">

        <header>
            ${panel('status_message')}
            <h1>On your mind</h1>
        </header>

        ${panel('chatter.post', chatter_form_url)}

    <div id="chatter-posts" class="pushdownContent">
      <div class="panel-item clearfix" tal:repeat="post recent">
        <div class="panel-item-content">
          <div>
            <a href="${post['creator_url']}">
              <img class="avatar" alt="${post['creator']}"
                   src="${post['creator_image_url']}" />
              <span class="fullname">${post['creator']}</span>
            </a>
            <div class="messagetext">
              ${structure:post['html']}
              <div class="repost" tal:condition="post['reposter']">
                Reposted by <a class="quip-name" href="#" ref="${post['reposter']}">@${post['reposter']}</a>
              </div>
              <div class="reply" tal:condition="post['reply']">
                In reply to <a class="quip-name" href="#" ref="${post['reply']}">@${post['reply']}</a>
              </div>
            </div>
            <div class="reply-box">
              ${panel('chatter.post', chatter_form_url, post['creator'], False, post['quip_id'])}
            </div>
            <div class="repost-box">
              <p>Repost this to your followers?</p>
              <form action="${chatter_form_url}" method="POST">
              <input type="hidden" name="text" value="${post['text']}" />
              <input type="hidden" name="repost" value="${post['creator']}" />
              <div class="btn-group">
                <button type="submit" class="btn btn-speak-rp">
                  Speak
                </button>
                <button type="submit" class="btn btn-cancel-rp">
                  Cancel
                </button>
              </div>
              </form>
            </div>
          </div>
          <div class="panel-footer clearfix">
            <div class="timeago-date"
                   title="${post['timeago']}">${post['timeago']}</div>
            <div class="post-options">
              <a href="#" class="chatter-reply">Reply</a> |
              <a href="#" class="chatter-repost">Repost</a> |
              <a href="${post['url']}">View</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div metal:use-macro="layout.macros['rss_icon']"/>

  <script language="javascript" type="text/javascript">
    //<![CDATA[
    var exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
    var setQuipTargets = function() {
        $('.quip').each(function(){
            $(this).html($(this).html().replace(exp,
                '<a class="quip-url" href="$1">$1</a>','ig'))
        })
        $('.quip-name').attr('href',
            function(i, val) {
                return window.head_data['chatter_url'] + "creators.html?creators=" + $(this).attr('ref');
            }
        );
        $('.quip-tag').attr('href',
            function(i, val) {
                return window.head_data['chatter_url'] + "tag.html?tag=" + $(this).attr('ref');
            }
        );
        $('.quip-community').attr('href',
            function(i, val) {
                return window.head_data['app_url'] + "/communities/" + $(this).attr('ref');
            }
        );
    }
    $(document).ready(function() {
        setQuipTargets();
        $('.timeago-date').mouseenter(function() {
            $(this).hide();$(this).next().show();
        });
        $('.post-options').mouseleave(function() {
            $(this).hide();$(this).prev().show();
        });
        $('.chatter-reply').click(function() {
            var replybox = $(this).parent().parent().prev().children('.reply-box');
            replybox.show();
            var textarea = replybox.find('.quip-text');
            textarea.focus();
            // ug, set focus after last char on the textarea
            var val = textarea.val();
            textarea.val('');
            textarea.val(val);
            return false;
        });
        $('.chatter-repost').click(function() {
            $(this).parent().parent().prev().children('.repost-box').show();
            return false;
        });
        $('.btn-cancel').click(function() {
            $(this).parent().parent().parent().parent().parent().parent().hide();
            return false;
        });
        $('.btn-cancel-rp').click(function() {
            $(this).parent().parent().parent().hide();
            return false;
        });
    });
    //]]>
  </script>


    </metal:content>
</metal:block>
